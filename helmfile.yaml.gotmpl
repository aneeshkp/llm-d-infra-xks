# llm-d-infra-xks - Infrastructure for llm-d on xKS (AKS/CoreWeave)
#
# Usage:
#   helmfile apply                                        # Deploy all operators
#   helmfile apply --selector name=cert-manager-operator  # Deploy only cert-manager
#   helmfile apply --selector name=sail-operator          # Deploy only istio
#   helmfile apply --selector name=lws-operator           # Deploy only lws
#   helmfile destroy                                      # Remove all

environments:
  default:
    values:
      - values.yaml

---

# Import operator helmfiles from GitHub
# Note: selectorsInherited=true ensures parent --selector flag filters child releases
helmfiles:
  # cert-manager operator
  - path: git::https://github.com/aneeshkp/cert-manager-operator-chart.git@helmfile.yaml.gotmpl?ref=main
    selectorsInherited: true
    values:
      - useSystemPodmanAuth: {{ .Values.useSystemPodmanAuth | default true }}
      - pullSecretFile: {{ .Values.pullSecretFile | default "" | quote }}

  # sail-operator (Istio) - OSSM 3.2.x / Istio 1.27+ with v1 InferencePool API
  - path: git::https://github.com/aneeshkp/sail-operator-chart.git@helmfile.yaml.gotmpl?ref=main
    selectorsInherited: true
    values:
      - useSystemPodmanAuth: {{ .Values.useSystemPodmanAuth | default true }}
      - pullSecretFile: {{ .Values.pullSecretFile | default "" | quote }}

  # lws-operator
  - path: git::https://github.com/aneeshkp/lws-operator-chart.git@helmfile.yaml.gotmpl?ref=main
    selectorsInherited: true
    values:
      - useSystemPodmanAuth: {{ .Values.useSystemPodmanAuth | default true }}
      - pullSecretFile: {{ .Values.pullSecretFile | default "" | quote }}

---

releases:
  - name: rhaiis-xks-kserve
    chart: oci://ghcr.io/pierdipi/kserve-rhaii-xks
    # Use dev variant until official builds are released to registry.redhat.io
    version: 3.4.0-ea.1-dev-0915be6
    namespace: opendatahub
    disableValidation: true
    # CRDs are applied separately via presync hook to avoid 1MB secret size limit
    hooks:
      # Apply CRDs before helm install via presync
      - events: ["presync"]
        showlogs: true
        command: "sh"
        args:
          - "-c"
          - |
            set -e
            CHART_DIR=$(mktemp -d)
            helm pull oci://ghcr.io/pierdipi/kserve-rhaii-xks --version 3.4.0-ea.1-dev-3be1464 --untar --untardir "$CHART_DIR"
            kubectl apply -f "$CHART_DIR"/kserve-rhaii-xks/crds/ --server-side
            rm -rf "$CHART_DIR"
